<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="styles/index.css">
    <title>Willqvist</title>
</head>
<body>
<div class="wrapper">
    <div class="side" id="info">
        <div class="closeSide" id="closeSide">
            <i class="fas fa-times"></i>
        </div>
        <div id="side-websites" class="sideContent">
            <div class="sideTitle">
                <h2>Websites</h2>
            </div>
            <div class="items">
                <div class="sideItem">
                    <div class="wq sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>Willqvist.com</h3>
                        <p>My personal website made using THREE.js for rendering 3d models.</p>
                        <div class="buttons">
                            <!--<div class="button"><a href="./willqvist">Read More</a></div>-->
                        </div>
                    </div>
                </div>
                <div class="sideItem">
                    <div class="eko sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>eko-vis.se</h3>
                        <p>A website made for a economic consulting buisness in Sweden. It uses Php as backend and is made to working on every size, from the smallest phone to the biggest screen.</p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="https://eko-vis.se">Visit</a></div>
                        </div>
                    </div>
                </div>
                <!--
                <div class="sideItem">
                    <div class="woj sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>Wojon.net</h3>
                        <p>Website made for a Swedish UF business. It uses modern website design to look unique compared to other websites.</p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="/wojon">Visit</a></div>
                        </div>
                    </div>
                </div>
                <div class="sideItem">
                    <div class="nor sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>NorthFoods</h3>
                        <p>A website created for a fake restaurant to display different new unique ideas within website development and design.</p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="/northfoods">Visit</a></div>
                        </div>
                    </div>
                </div>
                -->
            </div>
        </div>
        <div  id="side-about"  class="sideContent">
            <div class="sideTitle">
                <h2>About Me</h2>
            </div>
            <div class="aboutContentWrapper">
                <div class="innerSideContent">
                    <div class="titleHeader">
                        <div class="pf"></div>
                        <h2>Hi, I'm William Lundqvist.</h2>
                    </div>
                    <div class="aboutContent">
                        Since I was a kid I have always liked to create different things, everything from creating simple figures in woodworking class to painting. My interesst for programming began in my first year of high school when I saw a youtube video of someone building a website in under 20 minutes. I thought that was super cool that a person could transform text to a beautiful website. It was then I began thinking "I also want to create something like that" and since then my interesst for programming has grown more and more.
                    </div>
                    <div class="menu">
                        <ul>
                            <li class="menuItem menuItemVisible">Contact me</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div  id="side-games"  class="sideContent">
            <div class="sideTitle">
                <h2>Games</h2>
            </div>
            <div class="items">
                <div class="sideItem">
                    <div class="wmc sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>The Wisemans Clock</h3>
                        <p>Play as a mysterious man after the apocalypse destroyed the earth. You have to stop the apocalypse from happening by rewinding time and space. Do your best to stop the apocalypse by using the Wisemans Clock! </p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="https://gerrydos.itch.io/the-wisemans-clock">Play</a></div>
                        </div>
                    </div>
                </div>
                <div class="sideItem">
                    <div class="ufs sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>Unfaithful Storyteller</h3>
                        <p>The son of a father want to know the story about what happened to their grandpa, after realizing they haven't seen eachother for quite a while. The father will try and remember the story and it's up to you to shape father's story in the way you want. </p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="https://gerrydos.itch.io/the-unfaithfull-storyteller">Play</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div  id="side-other"  class="sideContent">
            <div class="sideTitle">
                <h2>Other Projects/Links</h2>
            </div>
            <div class="items">
                <div class="sideItem">
                    <div class="git sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>Github</h3>
                        <p>My github contains A variety or projects that I have created. Spanning from a simple game engine in c++ to a CMS system created in Typescript and node.js</p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="https://github.com/Willqvist">Visit</a></div>
                        </div>
                    </div>
                </div>
                <div class="sideItem">
                    <div class="linkin sideItemImage"></div>
                    <div class="sideItemContents">
                        <h3>Linkedin</h3>
                        <p>At Linkedin you can read more about me. You can contact me here for fast responses!</p>
                        <div class="buttons">
                            <div class="button"><a target="_blank" href="https://www.linkedin.com/in/william-lundqvist/">Visit</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="d3">
        <div class="logo" id="logo">
            <div class="inline hello">
                <p class="ll"><span>Hello, I'm</span></p>
            </div>
            <div class="inline">
                <p class="ll ll2"><span>William Lundqvist</span></p>
            </div>
            <div class="inline hello">
                <p class="ll ll3"><span>Swedish computer scientist</span></p>
            </div>
        </div>
        <div class="menuWrapper">
            <div class="menu" id="menu">
                <ul>
                    <li id="about" class=" menuItem mi1">About me</li>
                    <li id="websites" class="menuItem mi2">Websites</li>
                    <li id="games" class="menuItem mi3">Games</li>
                    <li id="other" class="menuItem mi4">Other Projects</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<script src="scripts/fader.js"></script>
<script type="module">
    import BezierCurve from './bezier/bezier.js';
    import * as THREE from './threejs/src/Three.js';
    import {GLTFLoader} from './threejs/examples/jsm/loaders/GLTFLoader.js'

    setupFader(false);

    const linkClick = document.getElementsByClassName("linkClick");
    let resized = false;

    const closeSide = document.getElementById("closeSide");

    for(let i = 0; i < linkClick.length; i++) {
        linkClick[i].addEventListener("click",()=> {
            var win = window.open(linkClick[i].getAttribute("data-link"), '_blank');
            win.focus();
        },false);
    }

    const d3 = document.getElementById("d3");
    let mousePos = new THREE.Vector3(0,0,0);
    let head = null;
    let eye_left = null, eye_right= null;
    let eyeLPos,eyeRPos;
    let scene = new THREE.Scene();
    scene.background = new THREE.Color(0xF4F1DE);
    let camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
    let renderer = new THREE.WebGLRenderer({
        antialias:true
    });
    renderer.setSize( window.innerWidth, window.innerHeight );
    d3.appendChild( renderer.domElement );

    let amLight = new THREE.AmbientLight( 0x707070 ); // soft white light
    scene.add( amLight );

    let hemiLight = new THREE.HemisphereLight( 0x87ceeb, 0xf0e1de, 0.7 );
    hemiLight.color.setHSL( 0.6, 1, 0.6 );
    hemiLight.position.set( 0, 1, 0 );
    scene.add( hemiLight );

    let dirLight = new THREE.DirectionalLight( 0xFDB813, 0.6 );
    dirLight.position.set( - 0, 1.75, 1 );
    scene.add( dirLight );
    camera.position.z = 10;
    let a = 0;

    let started =false;
    let manager = new THREE.LoadingManager();

    manager.onLoad = ()=> {
        started = true;
    }
    let open = false;
    //MENU ITEMS
    const menuItems = document.getElementsByClassName("menuItem");
    let headOrg = {x:-0,y:0,xHead:0};
    let mouseScreenPos = {clientX:window.innerWidth/2,clientY:window.innerHeight/2};
    let activeItem = null;
    for(let i = 0; i < menuItems.length; i++) {
        const item = menuItems[i];
        item.addEventListener("click",()=>{
            onActiveSlide(item.id);
            if(activeItem) {
                activeItem.className = activeItem.className.replace( "activeMenu","");
            }
            activeItem = item;
            item.className += " activeMenu";
        },false);
    }

    closeSide.addEventListener("click",()=>{
        onDeActiveSlide();
        if(activeItem) {
            activeItem.className = activeItem.className.replace( "activeMenu","");
            activeItem = null;
        }
    },false);


    function onActiveSlide(id) {
        console.log("acitivngat:",id);
        if(!open) {
            open = true;
            head.position.x = 0;
            //size.innerWidth = 0.5;
            d3.style.width = "50%";
            onWindowResize(size);
            let int = setInterval(()=>{
                //headOrg.x -= 0.1;
                //headOrg.xHead -= 0.1;
                if(headOrg.xHead < -3) headOrg.xHead = -3;
                if(headOrg.x < -0.6) headOrg.x = -0.6;
                onWindowResize(size);
                onDocumentMouseMove(mouseScreenPos);
            },1);
            setTimeout(()=>{
                document.getElementsByClassName("side")[0].className += " sideActive";
            },50);
            setTimeout(()=>{
                headOrg.x = -0.6;
                headOrg.xHead = -3;
                clearInterval(int);
                onDocumentMouseMove(mouseScreenPos);
            },500);
        }

        fillData(id);
    }

    function onDeActiveSlide() {
        if(open) {
            open = false;
            head.position.x = 0;
            //size.innerWidth = 0.5;
            d3.style.width = "100%";
            onWindowResize(size);
            let int = setInterval(()=>{
                headOrg.x += 0.1;
                headOrg.xHead += 0.1;
                if(headOrg.xHead > 0) headOrg.xHead = 0;
                if(headOrg.x > 0) headOrg.x = 0;
                onWindowResize(size);
                onDocumentMouseMove(mouseScreenPos);
            },1/60);
            setTimeout(()=>{
                let cls = document.getElementsByClassName("side")[0];
                cls.className = cls.className.replace(" sideActive","");
            },50);
            setTimeout(()=>{
                headOrg.x = 0;
                headOrg.xHead = 0;
                clearInterval(int);
                onDocumentMouseMove(mouseScreenPos);
            },500);
        }
    }

    let prevActive = null;

    function fillData(id) {
        if(prevActive)
            prevActive.style.display="none";
        let obj = document.getElementById("side-"+id);
        obj.style.display="flex";
        console.log(obj);
        prevActive = obj;
    }

    //adding shadow
    let loader = new THREE.TextureLoader();

    // Load an image file into a custom material
    let material = new THREE.MeshLambertMaterial({
        map: loader.load('./images/shade.png'),
        color: 0xFF0000,
        opacity:0.07
    });

    material.transparent = true;

    // create a plane geometry for the image with a width of 10
    // and a height that preserves the image's aspect ratio
    let geometry = new THREE.PlaneGeometry(4, 4);

    // combine our image geometry and material into a mesh
    let mesh = new THREE.Mesh(geometry, material);

    // set the position of the image mesh in the x,y,z dimensions
    mesh.position.set(0,-2.5,0)
    mesh.rotation.set(-1.6,0,0);
    mesh.scale.set(0,0,0);
    // add the image to the scene
    scene.add(mesh);


    let time = 0;

    let confused = false;

    let fadeSpeed = 0.008;

    let bezFunc = BezierCurve(.49,.31,0,1.56);

    let headAnim = 0;

    let size = {innerWidth:1,innerHeight:1};

    let prevEyeRPos = new THREE.Vector3(0,0,0);
    let prevEyeLPos = new THREE.Vector3(0,0,0);
    let prevHeadRot = new THREE.Object3D();
    let lerpSpeed = 0.5;
    let headLerpSpeed = lerpSpeed/2;
    let animate = function () {
        requestAnimationFrame( animate );
        if(started) {
            time++;
            if(time*fadeSpeed < 1) {
                let val = bezFunc(time * fadeSpeed);
                mesh.scale.set(val, val, val);
                head.scale.set(val, val, val);
                head.rotation.set((1-val),head.rotation.y,head.rotation.z);
            }
        }
        if(eye_right) {
            eye_right.position.lerp(prevEyeRPos, lerpSpeed);
            eye_left.position.lerp(prevEyeLPos, lerpSpeed);
            let rot = prevHeadRot.rotation;
            let vec = head.rotation.toVector3().lerp(prevHeadRot.rotation, headLerpSpeed);
            head.rotation.set(vec.x,vec.y,vec.z);
        }
        onWindowResize(size);
        renderer.render( scene, camera );
    };
    let mx=0,my=0;
    animate();

    loadModel(scene,'models/face_jag.glb');

    function loadModel(scene,path) {
        var loader = new GLTFLoader();

        loader.load( path, function ( gltf ) {
            console.log(gltf.scene);
            gltf.scene.traverse( child => {

                if ( child.material ) child.material.metalness = 0;

            } );

            document.getElementById("logo").className += " logoLoaded";
            document.getElementById("menu").className += " menuLoaded";
            setTimeout(()=> {
                document.getElementById("menu").className += " menuLoadedAfter";
            },700);
            started = true;
            head = gltf.scene;
            head.scale.set(0,0,0);
            head.rotation.set(Math.PI/4,0,0);
            eye_left = gltf.scene.getObjectByName("Eye_left");
            eye_right = gltf.scene.getObjectByName("Eye_right");
            eyeLPos = gltf.scene.getObjectByName("Eye_Left_Org");
            eyeRPos = gltf.scene.getObjectByName("Eye_Right_Org");
            scene.add( gltf.scene );
            onDocumentMouseMove(mouseScreenPos);
            //onActiveSlide("websites");

            //dispatchEvent(new Event('mousemove'));
        }, undefined, function ( error ) {

            console.error( error );

        } );
    }

    const raycaster = new THREE.Raycaster();

    function getWorldMousePosition(x,y) {

    }

    let mouse = new THREE.Vector2();
    let prevMouse = new THREE.Vector2();
    let dirRVector = new THREE.Vector2(0,0);
    let dirLVector = new THREE.Vector2(0,0);
    const zero = new THREE.Vector2(0,0);
    let mc = new THREE.Vector2(0,0);
    document.addEventListener('mousemove', onDocumentMouseMove, false);
    document.addEventListener('touchmove', onDocumentMouseMove, false);
    window.addEventListener('resize', (e)=>{
        resized = true;
    }, false);
    //document.addEventListener('mousedown', onMouseDown, false);


    function onDocumentMouseMove(event) {
        if(!head) return;
        if(event.touches) {
            event.clientX = event.touches[0].clientX;
            event.clientY = event.touches[0].clientY;
        }
        mouseScreenPos.clientX = event.clientX;
        mouseScreenPos.clientY = event.clientY;
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1-headOrg.x;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1-headOrg.y;
        let vector = new THREE.Vector3(mouse.x-headOrg.xHead,mouse.y,-1).unproject(camera);
        vector.multiplyScalar(4);
        vector.z = 2;
        prevMouse.set(mouse.x,mouse.y);
        prevHeadRot.lookAt(vector);

        vector = new THREE.Vector3(mouse.x,mouse.y,-1).unproject(camera);
        vector.multiplyScalar(1);
        let offset = 0.3;
        lookEye(eye_right,eyeRPos,-offset,prevEyeRPos,mouse);
        lookEye(eye_left,eyeLPos,offset,prevEyeLPos,mouse);
    }

    function lookEye(eye, eyePos, offX,vec,look) {
        let radius = 0.17;
        zero.x = offX;
        dirRVector.set(0,0);
        mc.x = look.x;
        mc.y = look.y;
        dirRVector.subVectors(mc.multiplyScalar(1),zero);
        if(dirRVector.length() > 1)
            dirRVector.normalize();

        dirRVector.multiplyScalar(radius);
        vec.set(eyePos.position.x,eyePos.position.y,eyePos.position.z);
        vec.add(new THREE.Vector3(dirRVector.x,dirRVector.y,0));
    }

    function onWindowResize(size, src = window) {
        renderer.setSize((d3.clientWidth*size.innerWidth), (src.innerHeight*size.innerHeight));
        camera.aspect = (d3.clientWidth*size.innerWidth) / (src.innerHeight*size.innerHeight);
        camera.updateProjectionMatrix();
    }

    document.addEventListener("mouseleave", function(event){

        if(event.clientY <= 0 || event.clientX <= 0 || (event.clientX >= window.innerWidth || event.clientY >= window.innerHeight))
        {
            lerpSpeed = 0.06;
            headLerpSpeed = lerpSpeed/2;
            console.log("I'm out");
            confused = setInterval(confusedSearch,2500);
        }
    });

    function confusedSearch() {

        let val = new THREE.Vector2(Math.random()*2-1,-Math.random()*2+1);
        let offset = 0.3;

        let vector = new THREE.Vector3(val.x,val.y,-1).unproject(camera);
        vector.multiplyScalar(4);
        vector.z = 2;
        prevMouse.set(mouse.x,mouse.y);
        prevHeadRot.lookAt(vector);

        lookEye(eye_right,eyeRPos,-offset,prevEyeRPos,val);
        lookEye(eye_left,eyeLPos,offset,prevEyeLPos,val);
    }

    document.addEventListener("mouseenter", function(event){
        mx=event.clientX;
        my=event.clientY;
        lerpSpeed = 0.5;
        headLerpSpeed = lerpSpeed/2;
        clearInterval(confused);
    });

</script>
</body>
</html>
